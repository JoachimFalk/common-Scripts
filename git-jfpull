#! /bin/sh

GITBRANCH=""
test -f .gitbranch && GITBRANCH=`cat .gitbranch`
ORIGINGITBRANCH="origin/$GITBRANCH"

if grep '^ref: refs/heads/' .git/HEAD >/dev/null; then
  if test -n "$GITBRANCH"; then
    git branch --set-upstream `sed -e 's/^ref: refs\/heads\///' .git/HEAD` "$ORIGINGITBRANCH"
  fi
  exec git pull
fi
if test -n "$GITBRANCH"; then
  GITBRANCHTMP=""
  if test -f ".git/refs/heads/$GITBRANCH"; then
    GITBRANCHTMP=`mktemp -u --tmpdir=.git/refs/heads "${GITBRANCH}.XXX"`
    GITBRANCHTMP=`basename "$GITBRANCHTMP"`
    git checkout -b "$GITBRANCHTMP"
    git checkout "$GITBRANCH"
    git merge "$GITBRANCHTMP" && git branch -d "$GITBRANCHTMP"
  else
    git checkout -b "$GITBRANCH"
    git branch --set-upstream `sed -e 's/^ref: refs\/heads\///' .git/HEAD` "$ORIGINGITBRANCH"
  fi
  exec git pull
# exec git checkout --track -b "$GITBRANCH" "remotes/origin/$GITBRANCH"
fi

echo "This project is missing .gitbranch, so I can't guess a valid branch name!"
exit -1
